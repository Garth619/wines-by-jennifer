tinymce.PluginManager.add("wpeditimage",function(e){function t(t){return!(!e.dom.getAttrib(t,"data-mce-placeholder")&&!e.dom.getAttrib(t,"data-mce-object"))}function n(t){var n=e.$(t).parents("[contenteditable]");return n&&"false"===n.attr("contenteditable")}function a(t){return t.replace(/(?:<p>)?\[(?:wp_)?caption([^\]]+)\]([\s\S]+?)\[\/(?:wp_)?caption\](?:<\/p>)?/g,function(t,n,a){var i,o,r,c,d,l;return i=n.match(/id=['"]([^'"]*)['"] ?/),i&&(n=n.replace(i[0],"")),o=n.match(/align=['"]([^'"]*)['"] ?/),o&&(n=n.replace(o[0],"")),r=n.match(/class=['"]([^'"]*)['"] ?/),r&&(n=n.replace(r[0],"")),l=n.match(/width=['"]([0-9]*)['"] ?/),l&&(n=n.replace(l[0],"")),a=f(a),d=a.match(/((?:<a [^>]+>)?<img [^>]+>(?:<\/a>)?)([\s\S]*)/i),d&&d[2]?(c=f(d[2]),d=f(d[1])):(c=f(n).replace(/caption=['"]/,"").replace(/['"]$/,""),d=a),i=i&&i[1]?i[1].replace(/[<>&]+/g,""):"",o=o&&o[1]?o[1]:"alignnone",r=r&&r[1]?" "+r[1].replace(/[<>&]+/g,""):"",!l&&d&&(l=d.match(/width=['"]([0-9]*)['"]/)),l&&l[1]&&(l=l[1]),l&&c?(l=parseInt(l,10),e.getParam("wpeditimage_html5_captions")||(l+=10),'<div class="mceTemp"><dl id="'+i+'" class="wp-caption '+o+r+'" style="width: '+l+'px"><dt class="wp-caption-dt">'+d+'</dt><dd class="wp-caption-dd">'+c+"</dd></dl></div>"):a})}function i(e){return e.replace(/(?:<div [^>]+mceTemp[^>]+>)?\s*(<dl [^>]+wp-caption[^>]+>[\s\S]+?<\/dl>)\s*(?:<\/div>)?/g,function(e,t){var n="";return t.indexOf("<img ")===-1||t.indexOf("</p>")!==-1?t.replace(/<d[ldt]( [^>]+)?>/g,"").replace(/<\/d[ldt]>/g,""):(n=t.replace(/\s*<dl ([^>]+)>\s*<dt [^>]+>([\s\S]+?)<\/dt>\s*<dd [^>]+>([\s\S]*?)<\/dd>\s*<\/dl>\s*/gi,function(e,t,n,a){var i,o,r,c;return c=n.match(/width="([0-9]*)"/),c=c&&c[1]?c[1]:"",o=t.match(/class="([^"]*)"/),o=o&&o[1]?o[1]:"",r=o.match(/align[a-z]+/i)||"alignnone",c&&a?(i=t.match(/id="([^"]*)"/),i=i&&i[1]?i[1]:"",o=o.replace(/wp-caption ?|align[a-z]+ ?/gi,""),o&&(o=' class="'+o+'"'),a=a.replace(/\r\n|\r/g,"\n").replace(/<[a-zA-Z0-9]+( [^<>]+)?>/g,function(e){return e.replace(/[\r\n\t]+/," ")}),a=a.replace(/\s*\n\s*/g,"<br />"),'[caption id="'+i+'" align="'+r+'" width="'+c+'"'+o+"]"+n+" "+a+"[/caption]"):("alignnone"!==r[0]&&(n=n.replace(/><img/,' class="'+r[0]+'"><img')),n)}),n.indexOf("[caption")===-1&&(n=t.replace(/[\s\S]*?((?:<a [^>]+>)?<img [^>]+>(?:<\/a>)?)(<p>[\s\S]*<\/p>)?[\s\S]*/gi,"<p>$1</p>$2")),n)})}function o(t){var n,a,i,o,r,c,d,l,s=[],p=e.dom,m=/^\d+$/;return i={attachment_id:!1,size:"custom",caption:"",align:"none",extraClasses:"",link:!1,linkUrl:"",linkClassName:"",linkTargetBlank:!1,linkRel:"",title:""},i.url=p.getAttrib(t,"src"),i.alt=p.getAttrib(t,"alt"),i.title=p.getAttrib(t,"title"),d=p.getAttrib(t,"width"),l=p.getAttrib(t,"height"),(!m.test(d)||parseInt(d,10)<1)&&(d=t.naturalWidth||t.width),(!m.test(l)||parseInt(l,10)<1)&&(l=t.naturalHeight||t.height),i.customWidth=i.width=d,i.customHeight=i.height=l,n=tinymce.explode(t.className," "),a=[],tinymce.each(n,function(e){/^wp-image/.test(e)?i.attachment_id=parseInt(e.replace("wp-image-",""),10):/^align/.test(e)?i.align=e.replace("align",""):/^size/.test(e)?i.size=e.replace("size-",""):a.push(e)}),i.extraClasses=a.join(" "),o=p.getParents(t,".wp-caption"),o.length&&(o=o[0],n=o.className.split(" "),tinymce.each(n,function(e){/^align/.test(e)?i.align=e.replace("align",""):e&&"wp-caption"!==e&&s.push(e)}),i.captionClassName=s.join(" "),r=p.select("dd.wp-caption-dd",o),r.length&&(r=r[0],i.caption=e.serializer.serialize(r).replace(/<br[^>]*>/g,"$&\n").replace(/^<p>/,"").replace(/<\/p>$/,""))),t.parentNode&&"A"===t.parentNode.nodeName&&(c=t.parentNode,i.linkUrl=p.getAttrib(c,"href"),i.linkTargetBlank="_blank"===p.getAttrib(c,"target"),i.linkRel=p.getAttrib(c,"rel"),i.linkClassName=c.className),i}function r(e){return e&&!(!e.textContent&&!e.innerText)}function c(t){return!t||t.indexOf("<")===-1&&t.indexOf(">")===-1?t:(m||(m=new tinymce.html.Serializer({},e.schema)),m.serialize(e.parser.parse(t,{forced_root_block:!1})))}function d(t,n){var a,i,o,d,l,s,p,m,g,u,h,f,w,N,v,_,b,C,y,P=e.dom;a=tinymce.explode(n.extraClasses," "),a||(a=[]),n.caption||a.push("align"+n.align),n.attachment_id&&(a.push("wp-image-"+n.attachment_id),n.size&&"custom"!==n.size&&a.push("size-"+n.size)),N=n.width,v=n.height,"custom"===n.size&&(N=n.customWidth,v=n.customHeight),f={src:n.url,width:N||null,height:v||null,title:n.title||null,class:a.join(" ")||null},P.setAttribs(t,f),e.$(t).attr("alt",n.alt||""),w={href:n.linkUrl,rel:n.linkRel||null,target:n.linkTargetBlank?"_blank":null,class:n.linkClassName||null},t.parentNode&&"A"===t.parentNode.nodeName&&!r(t.parentNode)?n.linkUrl?P.setAttribs(t.parentNode,w):P.remove(t.parentNode,!0):n.linkUrl&&((p=P.getParent(t,"a"))&&P.insertAfter(t,p),p=P.create("a",w),t.parentNode.insertBefore(p,t),p.appendChild(t)),m=e.dom.getParent(t,".mceTemp"),o=t.parentNode&&"A"===t.parentNode.nodeName&&!r(t.parentNode)?t.parentNode:t,n.caption?(n.caption=c(n.caption),h=n.attachment_id?"attachment_"+n.attachment_id:null,_="align"+(n.align||"none"),i="wp-caption "+_,n.captionClassName&&(i+=" "+n.captionClassName.replace(/[<>&]+/g,"")),e.getParam("wpeditimage_html5_captions")||(N=parseInt(N,10),N+=10),m?(u=P.select("dl.wp-caption",m),u.length&&P.setAttribs(u,{id:h,class:i,style:"width: "+N+"px"}),g=P.select(".wp-caption-dd",m),g.length&&P.setHTML(g[0],n.caption)):(h=h?'id="'+h+'" ':"",d="<dl "+h+'class="'+i+'" style="width: '+N+'px"><dt class="wp-caption-dt"></dt><dd class="wp-caption-dd">'+n.caption+"</dd></dl>",s=P.create("div",{class:"mceTemp"},d),(l=P.getParent(o,"p"))?l.parentNode.insertBefore(s,l):o.parentNode.insertBefore(s,o),e.$(s).find("dt.wp-caption-dt").append(o),l&&P.isEmpty(l)&&P.remove(l))):m&&(l=P.create("p"),m.parentNode.insertBefore(l,m),l.appendChild(o),P.remove(m)),b=e.$(t),C=b.attr("srcset"),y=b.attr("src"),C&&y&&(y=y.replace(/[?#].*/,""),C.indexOf(y)===-1&&b.attr("srcset",null).attr("sizes",null)),wp.media.events&&wp.media.events.trigger("editor:image-update",{editor:e,metadata:n,image:t}),e.nodeChanged()}function l(t){var n,a,i;if("undefined"==typeof wp||!wp.media)return void e.execCommand("mceImage");i=o(t),wp.media.events.trigger("editor:image-edit",{editor:e,metadata:i,image:t}),n=wp.media({frame:"image",state:"image-details",metadata:i}),wp.media.events.trigger("editor:frame-create",{frame:n}),a=function(a){e.focus(),e.undoManager.transact(function(){d(t,a)}),n.detach()},n.state("image-details").on("update",a),n.state("replace-image").on("replace",a),n.on("close",function(){e.focus(),n.detach()}),n.open()}function s(t){var n=e.dom.getParent(t,"div.mceTemp");n||"IMG"!==t.nodeName||(n=e.dom.getParent(t,"a")),n?(n.nextSibling?e.selection.select(n.nextSibling):n.previousSibling?e.selection.select(n.previousSibling):e.selection.select(n.parentNode),e.selection.collapse(!0),e.dom.remove(n)):e.dom.remove(t),e.nodeChanged(),e.undoManager.add()}var p,m,g,u,h=tinymce.each,f=tinymce.trim,w=tinymce.Env.iOS;return e.addButton("wp_img_remove",{tooltip:"Remove",icon:"dashicon dashicons-no",onclick:function(){s(e.selection.getNode())}}),e.addButton("wp_img_edit",{tooltip:"Edit ",icon:"dashicon dashicons-edit",onclick:function(){l(e.selection.getNode())}}),h({alignleft:"Align left",aligncenter:"Align center",alignright:"Align right",alignnone:"No alignment"},function(t,n){var a=n.slice(5);e.addButton("wp_img_"+n,{tooltip:t,icon:"dashicon dashicons-align-"+a,cmd:"alignnone"===n?"wpAlignNone":"Justify"+a.slice(0,1).toUpperCase()+a.slice(1),onPostRender:function(){var t=this;e.on("NodeChange",function(a){var i;"IMG"===a.element.nodeName&&(i=e.dom.getParent(a.element,".wp-caption")||a.element,"alignnone"===n?t.active(!/\balign(left|center|right)\b/.test(i.className)):t.active(e.dom.hasClass(i,n)))})}})}),e.once("preinit",function(){e.wp&&e.wp._createToolbar&&(p=e.wp._createToolbar(["wp_img_alignleft","wp_img_aligncenter","wp_img_alignright","wp_img_alignnone","wp_img_edit","wp_img_remove"]))}),e.on("wptoolbar",function(e){"IMG"!==e.element.nodeName||t(e.element)||(e.toolbar=p)}),w&&e.on("init",function(){e.on("touchstart",function(e){"IMG"!==e.target.nodeName||n(e.target)||(g=!0)}),e.dom.bind(e.getDoc(),"touchmove",function(){g=!1}),e.on("touchend",function(t){if(g&&"IMG"===t.target.nodeName&&!n(t.target)){var a=t.target;g=!1,window.setTimeout(function(){e.selection.select(a),e.nodeChanged()},100)}else p&&p.hide()})}),e.on("init",function(){var t=e.dom,n=e.getParam("wpeditimage_html5_captions")?"html5-captions":"html4-captions";t.addClass(e.getBody(),n),e.on("wpLoadImageForm",function(t){if(!e.getParam("wpeditimage_disable_captions")){var n={type:"textbox",flex:1,name:"wpcaption",minHeight:60,multiline:!0,scroll:!0,label:"Image caption"};t.data.splice(t.data.length-1,0,n)}}),e.on("wpNewImageRefresh",function(e){var n,a;(n=t.getParent(e.node,"dl.wp-caption"))&&(n.style.width||(a=parseInt(e.node.clientWidth,10)+10,a=a?a+"px":"50%",t.setStyle(n,"width",a)))}),e.on("wpImageFormSubmit",function(n){var a=n.imgData.data,i=n.imgData.node,o=n.imgData.wpcaption,r="",d="",l="",s=null,p,m,g,u;if(a.id="__wp-temp-img-id",n.imgData.cancel=!0,a.style||(a.style=null),!a.src)return void(i&&((p=t.getParent(i,"div.mceTemp"))?t.remove(p):"A"===i.parentNode.nodeName?t.remove(i.parentNode):t.remove(i),e.nodeChanged()));o&&(o=o.replace(/\r\n|\r/g,"\n").replace(/<\/?[a-zA-Z0-9]+( [^<>]+)?>/g,function(e){return e.replace(/[\r\n\t]+/," ")}),o=o.replace(/(<br[^>]*>)\s*\n\s*/g,"$1").replace(/\s*\n\s*/g,"<br />"),o=c(o)),i?(s=i.id||null,t.setAttribs(i,a),p=t.getParent(i,"dl.wp-caption"),o?p?(m=t.select("dd.wp-caption-dd",p)[0])&&(m.innerHTML=o):(i.className&&(r=i.className.match(/wp-image-([0-9]+)/),d=i.className.match(/align(left|right|center|none)/)),d?(d=d[0],i.className=i.className.replace(/align(left|right|center|none)/g,"")):d="alignnone",d=' class="wp-caption '+d+'"',r&&(r=' id="attachment_'+r[1]+'"'),l=a.width||i.clientWidth,l&&(l=parseInt(l,10),e.getParam("wpeditimage_html5_captions")||(l+=10),l=' style="width: '+l+'px"'),g=i.parentNode&&"A"===i.parentNode.nodeName?i.parentNode:i,u="<dl "+r+d+l+'><dt class="wp-caption-dt"></dt><dd class="wp-caption-dd">'+o+"</dd></dl>",p=t.create("div",{class:"mceTemp"},u),(m=t.getParent(g,"p"))?m.parentNode.insertBefore(p,m):g.parentNode.insertBefore(p,g),e.$(p).find("dt.wp-caption-dt").append(g),m&&t.isEmpty(m)&&t.remove(m)):p&&(u="A"===i.parentNode.nodeName?t.getOuterHTML(i.parentNode):t.getOuterHTML(i),m=t.create("p",{},u),t.insertAfter(m,p.parentNode),e.selection.select(m),e.nodeChanged(),t.remove(p.parentNode))):(u=t.createHTML("img",a),o?(g=e.selection.getNode(),a.width&&(l=parseInt(a.width,10),e.getParam("wpeditimage_html5_captions")||(l+=10),l=' style="width: '+l+'px"'),u='<dl class="wp-caption alignnone"'+l+'><dt class="wp-caption-dt">'+u+'</dt><dd class="wp-caption-dd">'+o+"</dd></dl>",m="P"===g.nodeName?g:t.getParent(g,"p"),m&&"P"===m.nodeName?(p=t.create("div",{class:"mceTemp"},u),m.parentNode.insertBefore(p,m),e.selection.select(p),e.nodeChanged(),t.isEmpty(m)&&t.remove(m)):e.selection.setContent('<div class="mceTemp">'+u+"</div>")):e.selection.setContent(u)),i=t.get("__wp-temp-img-id"),t.setAttrib(i,"id",s||null),n.imgData.node=i}),e.on("wpLoadImageData",function(n){var a,i=n.imgData.data,o=n.imgData.node;(a=t.getParent(o,"dl.wp-caption"))&&(a=t.select("dd.wp-caption-dd",a)[0])&&(i.wpcaption=e.serializer.serialize(a).replace(/<br[^>]*>/g,"$&\n").replace(/^<p>/,"").replace(/<\/p>$/,""))}),tinymce.Env.ie&&tinymce.Env.ie>10&&t.bind(e.getBody(),"mscontrolselect",function(n){"IMG"===n.target.nodeName&&t.getParent(n.target,".wp-caption")?e.getBody().focus():"DL"===n.target.nodeName&&t.hasClass(n.target,"wp-caption")&&n.target.focus()})}),e.on("ObjectResized",function(t){var n=t.target;"IMG"===n.nodeName&&e.undoManager.transact(function(){var a,i,o=e.dom;n.className=n.className.replace(/\bsize-[^ ]+/,""),(a=o.getParent(n,".wp-caption"))&&(i=t.width||o.getAttrib(n,"width"))&&(i=parseInt(i,10),e.getParam("wpeditimage_html5_captions")||(i+=10),o.setStyle(a,"width",i+"px"))})}),e.on("pastePostProcess",function(t){e.dom.getParent(e.selection.getNode(),"dd.wp-caption-dd")&&(e.$("img, audio, video, object, embed, iframe, script, style",t.node).remove(),e.$("*",t.node).each(function(t,n){e.dom.isBlock(n)&&(tinymce.trim(n.textContent||n.innerText)?(e.dom.insertAfter(e.dom.create("br"),n),e.dom.remove(n,!0)):e.dom.remove(n))}),e.$("br",t.node).each(function(t,n){n.nextSibling&&"BR"!==n.nextSibling.nodeName&&n.previousSibling&&"BR"!==n.previousSibling.nodeName||e.dom.remove(n)}),u=!0)}),e.on("BeforeExecCommand",function(t){var n,a,i,o,r,c,d=t.command,l=e.dom;if("mceInsertContent"===d||"Indent"===d||"Outdent"===d){if(n=e.selection.getNode(),c=l.getParent(n,"div.mceTemp")){if("mceInsertContent"!==d)return t.preventDefault(),t.stopImmediatePropagation(),!1;if(u)return void(u=!1);a=l.create("p"),l.insertAfter(a,c),e.selection.setCursorLocation(a,0),e.nodeChanged()}}else if("JustifyLeft"===d||"JustifyRight"===d||"JustifyCenter"===d||"wpAlignNone"===d){if(n=e.selection.getNode(),o="align"+d.slice(7).toLowerCase(),i=e.dom.getParent(n,".wp-caption"),"IMG"!==n.nodeName&&!i)return;n=i||n,r=e.dom.hasClass(n,o)?" alignnone":" "+o,n.className=f(n.className.replace(/ ?align(left|center|right|none)/g,"")+r),e.nodeChanged(),t.preventDefault(),p&&p.reposition(),e.fire("ExecCommand",{command:d,ui:t.ui,value:t.value})}}),e.on("keydown",function(t){var n,a,i,o,r=e.selection,c=t.keyCode,d=e.dom,l=tinymce.util.VK;if(c===l.ENTER)n=r.getNode(),(a=d.getParent(n,"div.mceTemp"))&&(d.events.cancel(t),tinymce.each(d.select("dt, dd",a),function(e){d.isEmpty(e)&&d.remove(e)}),o=tinymce.Env.ie&&tinymce.Env.ie<11?"":'<br data-mce-bogus="1" />',i=d.create("p",null,o),"DD"===n.nodeName?d.insertAfter(i,a):a.parentNode.insertBefore(i,a),e.nodeChanged(),r.setCursorLocation(i,0));else if((c===l.DELETE||c===l.BACKSPACE)&&(n=r.getNode(),"DIV"===n.nodeName&&d.hasClass(n,"mceTemp")?a=n:"IMG"!==n.nodeName&&"DT"!==n.nodeName&&"A"!==n.nodeName||(a=d.getParent(n,"div.mceTemp")),a))return d.events.cancel(t),s(n),!1}),tinymce.Env.gecko&&e.on("undo redo",function(){"IMG"===e.selection.getNode().nodeName&&e.selection.collapse()}),e.wpSetImgCaption=function(e){return a(e)},e.wpGetImgCaption=function(e){return i(e)},e.on("beforeGetContent",function(t){"raw"!==t.format&&e.$('img[id="__wp-temp-img-id"]').attr("id",null)}),e.on("BeforeSetContent",function(t){"raw"!==t.format&&(t.content=e.wpSetImgCaption(t.content))}),e.on("PostProcess",function(t){t.get&&(t.content=e.wpGetImgCaption(t.content))}),function(){var t;e.on("dragstart",function(){var n=e.selection.getNode();"IMG"===n.nodeName&&((t=e.dom.getParent(n,".mceTemp"))||"A"!==n.parentNode.nodeName||r(n.parentNode)||(t=n.parentNode))}),e.on("drop",function(n){var a=e.dom,i=tinymce.dom.RangeUtils.getCaretRangeFromPoint(n.clientX,n.clientY,e.getDoc());i&&a.getParent(i.startContainer,".mceTemp")?n.preventDefault():t&&(n.preventDefault(),e.undoManager.transact(function(){i&&e.selection.setRng(i),e.selection.setNode(t),a.remove(t)})),t=null})}(),e.wp=e.wp||{},e.wp.isPlaceholder=t,{_do_shcode:a,_get_shcode:i}});